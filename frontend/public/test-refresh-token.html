<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Refresh Token - Ho·∫°t ƒë·ªông 1</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #4CAF50;
            padding-bottom: 10px;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 10px 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #45a049;
        }
        .danger {
            background: #f44336;
        }
        .danger:hover {
            background: #da190b;
        }
        .info {
            background: #2196F3;
        }
        .info:hover {
            background: #0b7dda;
        }
        .output {
            background: #f9f9f9;
            border: 1px solid #ddd;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 300px;
            overflow-y: auto;
        }
        .success {
            color: #4CAF50;
            font-weight: bold;
        }
        .error {
            color: #f44336;
            font-weight: bold;
        }
        .token {
            word-break: break-all;
            background: #e8f5e9;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê Test Refresh Token Flow</h1>
        <p><strong>Ho·∫°t ƒë·ªông 1:</strong> Refresh Token & Session Management</p>
        
        <div>
            <h3>1. Authentication</h3>
            <button onclick="testLogin()">üîë Login</button>
            <button onclick="testSignup()">üìù Signup</button>
            <button class="danger" onclick="testLogout()">üö™ Logout</button>
        </div>

        <div>
            <h3>2. Token Management</h3>
            <button class="info" onclick="showTokens()">üëÄ Show Tokens</button>
            <button class="info" onclick="testRefresh()">üîÑ Test Refresh Token</button>
            <button class="danger" onclick="clearTokens()">üóëÔ∏è Clear Tokens</button>
        </div>

        <div>
            <h3>3. Protected API</h3>
            <button onclick="testProtectedRoute()">üõ°Ô∏è Call Protected API</button>
            <button onclick="testAutoRefresh()">‚ö° Test Auto-Refresh (Wait 401)</button>
        </div>

        <div id="output" class="output">
            <div class="success">‚úÖ S·∫µn s√†ng test! Click c√°c n√∫t ph√≠a tr√™n.</div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:4000/api';
        const output = document.getElementById('output');

        function log(message, type = 'info') {
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : '';
            const timestamp = new Date().toLocaleTimeString();
            output.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            output.scrollTop = output.scrollHeight;
        }

        function clearOutput() {
            output.innerHTML = '';
        }

        async function testLogin() {
            clearOutput();
            log('üîë Testing Login...');
            try {
                const response = await fetch(`${API_BASE}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'test@example.com',
                        password: '123456'
                    })
                });
                const data = await response.json();
                
                if (data.accessToken && data.refreshToken) {
                    localStorage.setItem('accessToken', data.accessToken);
                    localStorage.setItem('refreshToken', data.refreshToken);
                    log('‚úÖ Login th√†nh c√¥ng!', 'success');
                    log(`User: ${data.user.email} (${data.user.role})`);
                    log('‚úÖ Tokens ƒë√£ l∆∞u v√†o localStorage');
                    showTokens();
                } else {
                    log('‚ùå Kh√¥ng nh·∫≠n ƒë∆∞·ª£c tokens', 'error');
                }
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function testSignup() {
            clearOutput();
            log('üìù Testing Signup...');
            const randomEmail = `user${Date.now()}@test.com`;
            try {
                const response = await fetch(`${API_BASE}/signup`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: 'Test User',
                        email: randomEmail,
                        password: '123456'
                    })
                });
                const data = await response.json();
                
                if (data.accessToken && data.refreshToken) {
                    localStorage.setItem('accessToken', data.accessToken);
                    localStorage.setItem('refreshToken', data.refreshToken);
                    log('‚úÖ Signup th√†nh c√¥ng!', 'success');
                    log(`Email: ${randomEmail}`);
                    log('‚úÖ Tokens ƒë√£ l∆∞u v√†o localStorage');
                    showTokens();
                } else {
                    log('‚ùå Kh√¥ng nh·∫≠n ƒë∆∞·ª£c tokens', 'error');
                }
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        function showTokens() {
            const accessToken = localStorage.getItem('accessToken');
            const refreshToken = localStorage.getItem('refreshToken');
            
            log('--- TOKENS ---');
            if (accessToken) {
                log('Access Token:');
                output.innerHTML += `<div class="token">${accessToken.substring(0, 50)}...</div>`;
            } else {
                log('‚ùå Kh√¥ng c√≥ Access Token', 'error');
            }
            
            if (refreshToken) {
                log('Refresh Token:');
                output.innerHTML += `<div class="token">${refreshToken.substring(0, 50)}...</div>`;
            } else {
                log('‚ùå Kh√¥ng c√≥ Refresh Token', 'error');
            }
        }

        async function testRefresh() {
            clearOutput();
            log('üîÑ Testing Refresh Token...');
            const refreshToken = localStorage.getItem('refreshToken');
            
            if (!refreshToken) {
                log('‚ùå Kh√¥ng c√≥ Refresh Token. H√£y login tr∆∞·ªõc!', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/auth/refresh`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ refreshToken })
                });
                
                const data = await response.json();
                
                if (data.accessToken) {
                    localStorage.setItem('accessToken', data.accessToken);
                    log('‚úÖ Refresh th√†nh c√¥ng!', 'success');
                    log('‚úÖ Access Token m·ªõi ƒë√£ ƒë∆∞·ª£c l∆∞u');
                    showTokens();
                } else {
                    log('‚ùå Refresh th·∫•t b·∫°i', 'error');
                    log(`Response: ${JSON.stringify(data)}`);
                }
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function testProtectedRoute() {
            clearOutput();
            log('üõ°Ô∏è Testing Protected Route...');
            const accessToken = localStorage.getItem('accessToken');
            
            if (!accessToken) {
                log('‚ùå Kh√¥ng c√≥ Access Token. H√£y login tr∆∞·ªõc!', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/profile`, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                
                const data = await response.json();
                log('‚úÖ API call th√†nh c√¥ng!', 'success');
                log(`Response: ${JSON.stringify(data, null, 2)}`);
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function testAutoRefresh() {
            clearOutput();
            log('‚ö° Testing Auto-Refresh...');
            log('‚ÑπÔ∏è ƒê·ªÉ test t√≠nh nƒÉng n√†y:');
            log('1. M·ªü backend/auth.js');
            log('2. ƒê·ªïi ACCESS_TOKEN_EXPIRY th√†nh "5s"');
            log('3. Restart backend');
            log('4. Login l·∫°i');
            log('5. ƒê·ª£i 5 gi√¢y');
            log('6. G·ªçi API ‚Üí S·∫Ω t·ª± ƒë·ªông refresh!');
            log('');
            log('üìå Frontend axios interceptor s·∫Ω t·ª± ƒë·ªông:');
            log('  - Nh·∫≠n 401 Unauthorized');
            log('  - G·ªçi /auth/refresh');
            log('  - Retry request v·ªõi token m·ªõi');
        }

        async function testLogout() {
            clearOutput();
            log('üö™ Testing Logout...');
            const refreshToken = localStorage.getItem('refreshToken');
            
            if (!refreshToken) {
                log('‚ö†Ô∏è Ch∆∞a ƒëƒÉng nh·∫≠p');
                return;
            }

            try {
                await fetch(`${API_BASE}/logout`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ refreshToken })
                });
                
                localStorage.removeItem('accessToken');
                localStorage.removeItem('refreshToken');
                log('‚úÖ Logout th√†nh c√¥ng!', 'success');
                log('‚úÖ Tokens ƒë√£ ƒë∆∞·ª£c x√≥a');
                log('‚úÖ Refresh Token ƒë√£ b·ªã revoke ·ªü backend');
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        function clearTokens() {
            localStorage.removeItem('accessToken');
            localStorage.removeItem('refreshToken');
            clearOutput();
            log('‚úÖ ƒê√£ x√≥a t·∫•t c·∫£ tokens', 'success');
        }
    </script>
</body>
</html>
